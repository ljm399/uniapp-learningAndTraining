# 12-pinia-uni-app é¡¹ç›®æ£€æŸ¥æŠ¥å‘Š

> æ£€æŸ¥æ—¶é—´: 2024 å¹´ 12 æœˆ 4 æ—¥  
> åŸé¡¹ç›®æ—¶é—´: 2022 å¹´  
> é¡¹ç›®ç±»å‹: Pinia çŠ¶æ€ç®¡ç†å­¦ä¹ é¡¹ç›®

---

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå­¦ä¹ åœ¨ uni-app ä¸­ä½¿ç”¨ Pinia çŠ¶æ€ç®¡ç†çš„é¡¹ç›®ã€‚

---

## âš ï¸ å»ºè®®ä¼˜åŒ–å†…å®¹

### 1. Pinia å¯¼å…¥æ–¹å¼ä¼˜åŒ–

**æ–‡ä»¶**: `main.js` (ç¬¬ 2 è¡Œ)

**å½“å‰ä»£ç **:

```javascript
import * as Pinia from "pinia";
```

**é—®é¢˜è¯´æ˜**:

- ä½¿ç”¨ `import *` å¯¼å…¥æ•´ä¸ª Pinia åº“
- å¢åŠ äº†æ‰“åŒ…ä½“ç§¯
- ä¸åˆ©äº tree-shaking

**å»ºè®®**: æŒ‰éœ€å¯¼å…¥

**ä¿®æ”¹å»ºè®®**:

```javascript
import { createPinia } from "pinia";
```

**å®Œæ•´ç¤ºä¾‹**:

```javascript
// main.js
import App from "./App";
import { createSSRApp } from "vue";
import { createPinia } from "pinia";

export function createApp() {
  const app = createSSRApp(App);
  const pinia = createPinia();

  app.use(pinia);

  return {
    app,
    Pinia: pinia, // å¦‚æœéœ€è¦å¯¼å‡º
  };
}
```

---

### 2. Store å†™æ³•å»ºè®®å‡çº§

**æ–‡ä»¶**: `store/counter.js` (ç¬¬ 5-25 è¡Œ)

**å½“å‰ä»£ç **:

```javascript
export const useCounterStore = defineStore("counter", {
  state: () => {
    return {
      count: 800,
    };
  },
  actions: {
    increment() {
      this.count++;
    },
    decrement() {
      this.count--;
    },
  },
});
```

**é—®é¢˜è¯´æ˜**:

- ä½¿ç”¨çš„æ˜¯ Options API é£æ ¼
- Vue 3 æ¨èä½¿ç”¨ Composition API é£æ ¼
- Setup Store æ›´çµæ´»ï¼Œæ›´ç¬¦åˆ Vue 3 ä¹ æƒ¯

**å®˜æ–¹æ¨è**: ä½¿ç”¨ Setup Store å†™æ³•

**ä¿®æ”¹å»ºè®®**:

```javascript
import { ref, computed } from "vue";
import { defineStore } from "pinia";

export const useCounterStore = defineStore("counter", () => {
  // State
  const count = ref(800);

  // Getters
  const doubleCount = computed(() => count.value * 2);
  const isPositive = computed(() => count.value > 0);

  // Actions
  function increment() {
    count.value++;
  }

  function decrement() {
    count.value--;
  }

  function incrementBy(amount) {
    count.value += amount;
  }

  function reset() {
    count.value = 0;
  }

  // å¼‚æ­¥ action
  async function fetchCount() {
    try {
      // const res = await api.getCount()
      // count.value = res.data
    } catch (err) {
      console.error("è·å–æ•°æ®å¤±è´¥", err);
    }
  }

  return {
    // State
    count,
    // Getters
    doubleCount,
    isPositive,
    // Actions
    increment,
    decrement,
    incrementBy,
    reset,
    fetchCount,
  };
});
```

**ä¼˜åŠ¿**:

- âœ… æ›´ç¬¦åˆ Vue 3 Composition API é£æ ¼
- âœ… æ›´å¥½çš„ TypeScript æ”¯æŒ
- âœ… æ›´çµæ´»çš„ä»£ç ç»„ç»‡
- âœ… å¯ä»¥ä½¿ç”¨ Vue çš„å“åº”å¼ API

**å‚è€ƒæ–‡æ¡£**: https://pinia.vuejs.org/core-concepts/#setup-stores

---

## âœ… ä»ç„¶æœ‰æ•ˆçš„å†…å®¹

### 1. Pinia åŸºæœ¬ä½¿ç”¨æ–¹å¼

```javascript
import { defineStore } from "pinia";

export const useCounterStore = defineStore("counter", {
  state: () => ({ count: 0 }),
  actions: {
    increment() {
      this.count++;
    },
  },
});
```

âœ… Options Store å†™æ³•ä»ç„¶æœ‰æ•ˆ

---

### 2. SSR æ”¯æŒçš„åˆ›å»ºæ–¹å¼

```javascript
import { createSSRApp } from "vue";
import { createPinia } from "pinia";

export function createApp() {
  const app = createSSRApp(App);
  app.use(createPinia());
  return { app };
}
```

âœ… SSR åˆ›å»ºæ–¹å¼æ­£ç¡®

---

### 3. Store ä½¿ç”¨æ–¹å¼

```vue
<script setup>
import { useCounterStore } from "@/store/counter";

const counterStore = useCounterStore();

// è®¿é—® state
console.log(counterStore.count);

// è°ƒç”¨ action
counterStore.increment();
</script>
```

âœ… ä½¿ç”¨æ–¹å¼æ­£ç¡®

---

## ğŸ’¡ æ‰©å±•å»ºè®®

### 1. æ·»åŠ  Getters

```javascript
export const useCounterStore = defineStore("counter", () => {
  const count = ref(800);

  // Getters
  const doubleCount = computed(() => count.value * 2);
  const displayText = computed(() => `å½“å‰è®¡æ•°: ${count.value}`);

  return {
    count,
    doubleCount,
    displayText,
  };
});
```

---

### 2. æ·»åŠ æŒä¹…åŒ–

å®‰è£…æ’ä»¶:

```bash
npm install pinia-plugin-persistedstate
```

é…ç½®:

```javascript
// main.js
import { createPinia } from "pinia";
import piniaPluginPersistedstate from "pinia-plugin-persistedstate";

export function createApp() {
  const app = createSSRApp(App);
  const pinia = createPinia();

  pinia.use(piniaPluginPersistedstate);
  app.use(pinia);

  return { app };
}
```

ä½¿ç”¨:

```javascript
export const useCounterStore = defineStore(
  "counter",
  () => {
    const count = ref(800);

    function increment() {
      count.value++;
    }

    return { count, increment };
  },
  {
    persist: true, // å¯ç”¨æŒä¹…åŒ–
  }
);
```

---

### 3. å¤šä¸ª Store ç»„åˆä½¿ç”¨

**åˆ›å»ºå¤šä¸ª Store**:

```javascript
// store/user.js
export const useUserStore = defineStore("user", () => {
  const userInfo = ref(null);
  const isLogin = computed(() => !!userInfo.value);

  function setUser(info) {
    userInfo.value = info;
  }

  function logout() {
    userInfo.value = null;
  }

  return { userInfo, isLogin, setUser, logout };
});

// store/cart.js
export const useCartStore = defineStore("cart", () => {
  const items = ref([]);
  const total = computed(() => {
    return items.value.reduce((sum, item) => sum + item.price * item.count, 0);
  });

  function addItem(item) {
    items.value.push(item);
  }

  function removeItem(id) {
    const index = items.value.findIndex((item) => item.id === id);
    if (index > -1) {
      items.value.splice(index, 1);
    }
  }

  return { items, total, addItem, removeItem };
});
```

**åœ¨ç»„ä»¶ä¸­ä½¿ç”¨**:

```vue
<script setup>
import { useUserStore } from "@/store/user";
import { useCartStore } from "@/store/cart";

const userStore = useUserStore();
const cartStore = useCartStore();

// ä½¿ç”¨å¤šä¸ª store
console.log(userStore.isLogin);
console.log(cartStore.total);
</script>
```

---

### 4. Store ä¹‹é—´äº’ç›¸è°ƒç”¨

```javascript
// store/order.js
import { useUserStore } from "./user";
import { useCartStore } from "./cart";

export const useOrderStore = defineStore("order", () => {
  const orders = ref([]);

  async function createOrder() {
    const userStore = useUserStore();
    const cartStore = useCartStore();

    if (!userStore.isLogin) {
      uni.showToast({
        title: "è¯·å…ˆç™»å½•",
        icon: "none",
      });
      return;
    }

    const order = {
      userId: userStore.userInfo.id,
      items: cartStore.items,
      total: cartStore.total,
      createTime: Date.now(),
    };

    orders.value.push(order);
    cartStore.items = []; // æ¸…ç©ºè´­ç‰©è½¦

    return order;
  }

  return { orders, createOrder };
});
```

---

## ğŸ”§ éœ€è¦æ‰§è¡Œçš„æ“ä½œ

### å»ºè®®ä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§ âš ï¸)

1. âš ï¸ å°† `import * as Pinia` æ”¹ä¸º `import { createPinia }`
2. âš ï¸ å°† Options Store æ”¹ä¸º Setup Store
3. âš ï¸ æ·»åŠ  Getters è®¡ç®—å±æ€§
4. âš ï¸ è€ƒè™‘æ·»åŠ æŒä¹…åŒ–æ’ä»¶
5. âš ï¸ åˆ›å»ºæ›´å¤šå®ç”¨çš„ Store

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Pinia å®˜æ–¹æ–‡æ¡£](https://pinia.vuejs.org/)
- [Setup Stores](https://pinia.vuejs.org/core-concepts/#setup-stores)
- [Pinia æŒä¹…åŒ–æ’ä»¶](https://github.com/prazdevs/pinia-plugin-persistedstate)
- [uni-app ä½¿ç”¨ Pinia](https://uniapp.dcloud.net.cn/tutorial/vue3-pinia.html)

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ä»£ç 

### main.js

```javascript
import App from "./App";
import { createSSRApp } from "vue";
import { createPinia } from "pinia";

export function createApp() {
  const app = createSSRApp(App);
  const pinia = createPinia();

  app.use(pinia);

  return {
    app,
    Pinia: pinia,
  };
}
```

### store/counter.js (Setup Store)

```javascript
import { ref, computed } from "vue";
import { defineStore } from "pinia";

export const useCounterStore = defineStore("counter", () => {
  // State
  const count = ref(800);

  // Getters
  const doubleCount = computed(() => count.value * 2);
  const isEven = computed(() => count.value % 2 === 0);

  // Actions
  function increment() {
    count.value++;
  }

  function decrement() {
    count.value--;
  }

  function incrementBy(amount) {
    count.value += amount;
  }

  function reset() {
    count.value = 0;
  }

  // å¼‚æ­¥ action
  async function fetchData() {
    try {
      // æ¨¡æ‹Ÿ API è¯·æ±‚
      const res = await new Promise((resolve) => {
        setTimeout(() => {
          resolve({ data: 100 });
        }, 1000);
      });
      count.value = res.data;
    } catch (err) {
      console.error("è·å–æ•°æ®å¤±è´¥", err);
    }
  }

  return {
    count,
    doubleCount,
    isEven,
    increment,
    decrement,
    incrementBy,
    reset,
    fetchData,
  };
});
```

### åœ¨é¡µé¢ä¸­ä½¿ç”¨

```vue
<template>
  <view class="container">
    <text>è®¡æ•°: {{ counterStore.count }}</text>
    <text>åŒå€: {{ counterStore.doubleCount }}</text>
    <text>æ˜¯å¦ä¸ºå¶æ•°: {{ counterStore.isEven ? "æ˜¯" : "å¦" }}</text>

    <button @click="counterStore.increment">+1</button>
    <button @click="counterStore.decrement">-1</button>
    <button @click="counterStore.incrementBy(10)">+10</button>
    <button @click="counterStore.reset">é‡ç½®</button>
    <button @click="counterStore.fetchData">è·å–æ•°æ®</button>
  </view>
</template>

<script setup>
import { useCounterStore } from "@/store/counter";

const counterStore = useCounterStore();
</script>
```

---

**æ£€æŸ¥å®Œæˆ** âœ“

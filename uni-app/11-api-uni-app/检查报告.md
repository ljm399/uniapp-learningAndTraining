# 11-api-uni-app é¡¹ç›®æ£€æŸ¥æŠ¥å‘Š

> æ£€æŸ¥æ—¶é—´: 2024 å¹´ 12 æœˆ 4 æ—¥  
> åŸé¡¹ç›®æ—¶é—´: 2022 å¹´  
> é¡¹ç›®ç±»å‹: uni-app API ä½¿ç”¨å­¦ä¹ é¡¹ç›®

---

## ğŸ“‹ æ£€æŸ¥æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªå­¦ä¹  uni-app API çš„é¡¹ç›®ï¼ŒåŒ…å«é¡µé¢è·³è½¬ã€æ•°æ®ä¼ é€’ç­‰åŠŸèƒ½ã€‚

---

## âŒ ä¸æ¨èä½¿ç”¨çš„å†…å®¹

### 1. å…¨å±€äº‹ä»¶æ€»çº¿å·²ä¸æ¨è

**æ–‡ä»¶**: `pages/home/home.vue` (ç¬¬ 23-31 è¡Œ)

**é—®é¢˜ä»£ç **:

```javascript
onLoad(() => {
  uni.$on("acceptDataFormDetail03", acceptDataFormDetail03);
});
onUnload(() => {
  uni.$off("acceptDataFormDetail03", acceptDataFormDetail03);
});
```

**é—®é¢˜è¯´æ˜**:

- `uni.$on` / `uni.$off` / `uni.$emit` å…¨å±€äº‹ä»¶æ€»çº¿å·²ä¸æ¨èä½¿ç”¨
- å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼
- äº‹ä»¶ç®¡ç†æ··ä¹±
- éš¾ä»¥è¿½è¸ªæ•°æ®æµ

**å®˜æ–¹æ¨è**: ä½¿ç”¨ä»¥ä¸‹æ›¿ä»£æ–¹æ¡ˆ

---

### æ¨èæ›¿ä»£æ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: ä½¿ç”¨ Pinia çŠ¶æ€ç®¡ç†ï¼ˆå¼ºçƒˆæ¨èï¼‰

**åˆ›å»º store**:

```javascript
// store/message.js
import { defineStore } from "pinia";
import { ref } from "vue";

export const useMessageStore = defineStore("message", () => {
  const messageData = ref(null);

  function setMessage(data) {
    messageData.value = data;
  }

  function clearMessage() {
    messageData.value = null;
  }

  return {
    messageData,
    setMessage,
    clearMessage,
  };
});
```

**å‘é€æ•°æ®**:

```javascript
// pages/detail03/detail03.vue
import { useMessageStore } from "@/store/message";

const messageStore = useMessageStore();

function sendData() {
  messageStore.setMessage({
    data: "æˆ‘æ˜¯detail03ä¼ é€’ç»™homeé¡µé¢çš„æ•°æ®",
  });
  uni.navigateBack();
}
```

**æ¥æ”¶æ•°æ®**:

```javascript
// pages/home/home.vue
import { useMessageStore } from "@/store/message";
import { watch } from "vue";

const messageStore = useMessageStore();

watch(
  () => messageStore.messageData,
  (newData) => {
    if (newData) {
      console.log("æ¥æ”¶åˆ°æ•°æ®:", newData);
      messageStore.clearMessage();
    }
  }
);
```

---

#### æ–¹æ¡ˆ 2: ä½¿ç”¨ mitt äº‹ä»¶æ€»çº¿åº“

**å®‰è£… mitt**:

```bash
npm install mitt
```

**åˆ›å»ºäº‹ä»¶æ€»çº¿**:

```javascript
// utils/eventBus.js
import mitt from "mitt";
export const eventBus = mitt();
```

**å‘é€äº‹ä»¶**:

```javascript
// pages/detail03/detail03.vue
import { eventBus } from "@/utils/eventBus";

function sendData() {
  eventBus.emit("acceptDataFormDetail03", {
    data: "æˆ‘æ˜¯detail03ä¼ é€’çš„æ•°æ®",
  });
  uni.navigateBack();
}
```

**ç›‘å¬äº‹ä»¶**:

```javascript
// pages/home/home.vue
import { eventBus } from "@/utils/eventBus";
import { onMounted, onUnmounted } from "vue";

function handleData(value) {
  console.log("æ¥æ”¶åˆ°æ•°æ®:", value);
}

onMounted(() => {
  eventBus.on("acceptDataFormDetail03", handleData);
});

onUnmounted(() => {
  eventBus.off("acceptDataFormDetail03", handleData);
});
```

---

#### æ–¹æ¡ˆ 3: ä½¿ç”¨ eventChannelï¼ˆé¡µé¢é—´é€šä¿¡ï¼‰

**æ­£å‘ä¼ é€’æ•°æ®**:

```javascript
// pages/home/home.vue
function goToDetail01() {
  uni.navigateTo({
    url: "/pages/detail01/detail01?name=liujun&id=100",
    success(res) {
      res.eventChannel.emit("acceptDataFormHomePage", {
        data: "æˆ‘æ˜¯homeé¡µé¢ä¼ é€’ç»™detail01çš„æ•°æ®",
      });
    },
  });
}
```

**æ¥æ”¶æ•°æ®**:

```javascript
// pages/detail01/detail01.vue
import { onLoad } from "@dcloudio/uni-app";

onLoad(() => {
  const eventChannel = this.getOpenerEventChannel();
  eventChannel.on("acceptDataFormHomePage", (data) => {
    console.log("æ¥æ”¶åˆ°æ•°æ®:", data);
  });
});
```

**é€†å‘ä¼ é€’æ•°æ®**:

```javascript
// pages/home/home.vue
function goToDetail02() {
  uni.navigateTo({
    url: "/pages/detail02/detail02",
    events: {
      acceptDataFormDetail02(value) {
        console.log("æ¥æ”¶åˆ°detail02ä¼ é€’çš„æ•°æ®", value);
      },
    },
  });
}
```

```javascript
// pages/detail02/detail02.vue
function sendData() {
  const eventChannel = this.getOpenerEventChannel();
  eventChannel.emit("acceptDataFormDetail02", {
    data: "æˆ‘æ˜¯detail02ä¼ é€’çš„æ•°æ®",
  });
}
```

âœ… **eventChannel æ–¹å¼ä»ç„¶æœ‰æ•ˆä¸”æ¨èä½¿ç”¨**

---

## âœ… ä»ç„¶æœ‰æ•ˆçš„å†…å®¹

### 1. uni.navigateTo API

```javascript
uni.navigateTo({
  url: "/pages/detail01/detail01?name=liujun&id=100",
  success(res) {
    console.log("è·³è½¬æˆåŠŸ");
  },
  fail(err) {
    console.log("è·³è½¬å¤±è´¥", err);
  },
});
```

âœ… API ä½¿ç”¨æ­£ç¡®

**å¸¸ç”¨å¯¼èˆª API**:

- `uni.navigateTo`: ä¿ç•™å½“å‰é¡µé¢ï¼Œè·³è½¬åˆ°æ–°é¡µé¢
- `uni.redirectTo`: å…³é—­å½“å‰é¡µé¢ï¼Œè·³è½¬åˆ°æ–°é¡µé¢
- `uni.reLaunch`: å…³é—­æ‰€æœ‰é¡µé¢ï¼Œæ‰“å¼€æ–°é¡µé¢
- `uni.switchTab`: è·³è½¬åˆ° tabBar é¡µé¢
- `uni.navigateBack`: è¿”å›ä¸Šä¸€é¡µ

---

### 2. ç”Ÿå‘½å‘¨æœŸå¯¼å…¥

```javascript
import { onLoad, onUnload } from "@dcloudio/uni-app";

onLoad(() => {
  console.log("é¡µé¢åŠ è½½");
});

onUnload(() => {
  console.log("é¡µé¢å¸è½½");
});
```

âœ… ç”Ÿå‘½å‘¨æœŸä½¿ç”¨æ­£ç¡®

---

## ğŸ’¡ ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨ Composition API

**å½“å‰å†™æ³•**:

```vue
<script>
export default {
  methods: {
    goToDetail01() {},
  },
};
</script>
```

**æ¨èå†™æ³•**:

```vue
<script setup>
import { onLoad } from "@dcloudio/uni-app";

function goToDetail01() {
  uni.navigateTo({
    url: "/pages/detail01/detail01?name=liujun&id=100",
  });
}

onLoad(() => {
  console.log("é¡µé¢åŠ è½½");
});
</script>
```

---

### 2. ç»Ÿä¸€æ•°æ®ä¼ é€’æ–¹æ¡ˆ

å»ºè®®åœ¨é¡¹ç›®ä¸­ç»Ÿä¸€ä½¿ç”¨ä¸€ç§æ•°æ®ä¼ é€’æ–¹æ¡ˆï¼š

**å°å‹é¡¹ç›®**: ä½¿ç”¨ eventChannel  
**ä¸­å‹é¡¹ç›®**: ä½¿ç”¨ mitt  
**å¤§å‹é¡¹ç›®**: ä½¿ç”¨ Piniaï¼ˆæ¨èï¼‰

---

### 3. æ·»åŠ é”™è¯¯å¤„ç†

```javascript
async function goToDetail() {
  try {
    await uni.navigateTo({
      url: "/pages/detail/detail",
    });
  } catch (err) {
    console.error("è·³è½¬å¤±è´¥", err);
    uni.showToast({
      title: "é¡µé¢è·³è½¬å¤±è´¥",
      icon: "none",
    });
  }
}
```

---

## ğŸ”§ éœ€è¦æ‰§è¡Œçš„æ“ä½œ

### ç«‹å³ä¿®æ”¹ (é«˜ä¼˜å…ˆçº§ âŒ)

1. âŒ ç§»é™¤æ‰€æœ‰ `uni.$on` / `uni.$off` / `uni.$emit` çš„ä½¿ç”¨
2. âŒ ä½¿ç”¨ Pinia æˆ– mitt æ›¿ä»£å…¨å±€äº‹ä»¶æ€»çº¿
3. âŒ ä½¿ç”¨ eventChannel å¤„ç†é¡µé¢é—´é€šä¿¡

### å»ºè®®ä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§ âš ï¸)

1. âš ï¸ æ”¹ç”¨ Composition API
2. âš ï¸ æ·»åŠ é”™è¯¯å¤„ç†
3. âš ï¸ ç»Ÿä¸€æ•°æ®ä¼ é€’æ–¹æ¡ˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [é¡µé¢é€šä¿¡](https://uniapp.dcloud.net.cn/api/window/communication.html)
- [é¡µé¢è·¯ç”±](https://uniapp.dcloud.net.cn/api/router.html)
- [Pinia å®˜æ–¹æ–‡æ¡£](https://pinia.vuejs.org/)
- [mitt GitHub](https://github.com/developit/mitt)

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹ä»£ç 

### ä½¿ç”¨ Pinia çš„å®Œæ•´ç¤ºä¾‹

**store/message.js**:

```javascript
import { defineStore } from "pinia";
import { ref } from "vue";

export const useMessageStore = defineStore("message", () => {
  const messages = ref({});

  function setMessage(key, data) {
    messages.value[key] = data;
  }

  function getMessage(key) {
    return messages.value[key];
  }

  function clearMessage(key) {
    delete messages.value[key];
  }

  return {
    messages,
    setMessage,
    getMessage,
    clearMessage,
  };
});
```

**pages/home/home.vue**:

```vue
<template>
  <view>
    <button @click="goToDetail03">è·³è½¬åˆ° detail03</button>
  </view>
</template>

<script setup>
import { watch } from "vue";
import { useMessageStore } from "@/store/message";

const messageStore = useMessageStore();

function goToDetail03() {
  uni.navigateTo({
    url: "/pages/detail03/detail03?name=liujun&id=300",
  });
}

// ç›‘å¬æ¶ˆæ¯å˜åŒ–
watch(
  () => messageStore.getMessage("detail03ToHome"),
  (data) => {
    if (data) {
      console.log("æ¥æ”¶åˆ°detail03ä¼ é€’çš„æ•°æ®:", data);
      messageStore.clearMessage("detail03ToHome");
    }
  }
);
</script>
```

**pages/detail03/detail03.vue**:

```vue
<template>
  <view>
    <button @click="sendData">å‘é€æ•°æ®å¹¶è¿”å›</button>
  </view>
</template>

<script setup>
import { useMessageStore } from "@/store/message";

const messageStore = useMessageStore();

function sendData() {
  messageStore.setMessage("detail03ToHome", {
    data: "æˆ‘æ˜¯detail03ä¼ é€’ç»™homeçš„æ•°æ®",
    timestamp: Date.now(),
  });
  uni.navigateBack();
}
</script>
```

---

**æ£€æŸ¥å®Œæˆ** âœ“

**é‡è¦æé†’**: è¯·å°½å¿«ç§»é™¤ `uni.$on/off/emit`ï¼Œä½¿ç”¨ Pinia æˆ– mitt æ›¿ä»£ï¼
